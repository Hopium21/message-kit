# GPT

Messages that start with `@bot` will trigger the GPT response.

```bash [cmd]
@bot hey, which games can i play?
```

## Logic

In this case the bot replies with context about the group like users and commands.

```jsx [src/handler/gpt.ts]
import { HandlerContext } from "@xmtp/mkit";
import { users } from "../lib/users.js";
import openaiCall from "../lib/gpt.js";

export async function handler(context: HandlerContext, commands: any) {
  const { content, senderAddress } = context.message;
  const { content: text } = content;
  const systemPrompt = `You are a helpful assistant that lives inside a web3 messaging group.\n
  This are the users of the group:${JSON.stringify(users)}\n
  This group bot has many commands avaiable: ${JSON.stringify(commands)}\n
  When possible, answer with the command from the list for the user to perform. put this command in a new line\n
  The message was sent by ${senderAddress}`;

  let message = text.replace("@bot", "");
  let { reply } = await openaiCall(message, senderAddress, systemPrompt);

  await context.reply(`${reply}`);
}
```

## OpenAI middleware

### Install dependency

```bash [cmd]
yarn add openai
```

Copy the following code into your `lib/gpt.js` file.

```jsx [src/lib/gpt.js]
import OpenAI from "openai";

const openai = new OpenAI({
  apiKey: process.env.OPEN_AI_API_KEY,
});

// Use a Map to store daily question counts per user
let dailyQuestionCountPerUser: Map<string, Record<string, number>> = new Map();

export default async function openaiCall(
  content: string,
  senderAddress: string,
  systemPrompt: string,
) {
  let messages = [
    {
      role: "system",
      content: systemPrompt,
    },
  ];
  // Check if the limit of 5 questions per day has been reached
  const today = new Date().toISOString().slice(0, 10); // Format: YYYY-MM-DD
  let userDailyCount = dailyQuestionCountPerUser.get(senderAddress) || {};

  try {
    if (content.toLowerCase() === "stop") {
      // Reset the conversation state
      messages = [
        {
          role: "system",
          content: systemPrompt,
        },
      ];
    } else {
      // Add the user's message to the conversation history
      messages.push({
        role: "user",
        content: content,
      });
    }
    const response = await openai.chat.completions.create({
      model: "gpt-4o",
      messages: messages as any,
    });
    const reply = response.choices[0].message.content;
    // Add the assistant's reply to the conversation history
    messages.push({
      role: "assistant",
      content: reply || "No response from OpenAI.",
    });

    userDailyCount[today] = (userDailyCount[today] || 0) + 1;
    dailyQuestionCountPerUser.set(senderAddress, userDailyCount);

    return { reply, messages };
  } catch (error) {
    console.error("Failed to fetch from OpenAI:", error);
    throw error;
  }
}
```
