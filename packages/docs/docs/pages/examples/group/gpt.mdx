# AI Bot

This is a simple bot that replies with gpt

## Structure

> Check out the [repository](https://github.com/xmtp-labs/botkit/tree/main/examples/gpt) for the full code.

```
bot-project/            # Your project's root directory.
├── lib/
│   ├── gpt.ts          # OpenAI GPT-4o API call // [!code hl] // [!code focus]
├── src/
│   ├── index.ts        # simple gpt bot // [!code hl] // [!code focus]
├── package.json
├── tsconfig.json
└── .env
```

## Logic

In this case the bot replies with gpt

```jsx [src/index.ts]
import "dotenv/config";
import { run, HandlerContext } from "@xmtp/botkit";
import openaiCall from "./lib/gpt.js";

run(async (context: HandlerContext) => {
  const { content, typeId, senderAddress } = context.message;
  const { content: text } = content;

  // Initialize an array to store the conversation history
  const systemPrompt =
    "You are a helpful assistant that lives inside a web3 messaging app. You love blockchain and decentralization and you are quite funny. You often tell crypto jokes.";

  try {
    let { reply } = await openaiCall(text, senderAddress, systemPrompt);

    await context.textReply(`${reply}`);
  } catch (error) {
    // Handle the error, for example, by sending an error message to the user
    await context.textReply(
      "Failed to process your request. Please try again later.",
    );
  }
});
```

### Variables

Set up this variables in your bot yo connect to GPT and xmtp

```bash
KEY= # 0x... the private key of the bot (with the 0x prefix)
XMTP_ENV=production # or `dev`
OPEN_AI_API_KEY= # openai api key
```

# GPT

The GPT middleware allows you to integrate OpenAI's GPT model into your chatbot.

## Install dependency

```bash
yarn add openai
```

## OpenAI middleware

Copy the following code into your `lib/gpt.js` file.

```jsx [lib/gpt.js]
import OpenAI from "openai";

const openai = new OpenAI({
  apiKey: process.env.OPEN_AI_API_KEY,
});

// Use a Map to store daily question counts per user
let dailyQuestionCountPerUser: Map<string, Record<string, number>> = new Map();

export default async function openaiCall(
  content: string,
  senderAddress: string,
  systemPrompt: string,
) {
  let messages = [
    {
      role: "system",
      content: systemPrompt,
    },
  ];
  // Check if the limit of 5 questions per day has been reached
  const today = new Date().toISOString().slice(0, 10); // Format: YYYY-MM-DD
  let userDailyCount = dailyQuestionCountPerUser.get(senderAddress) || {};
  /*if (userDailyCount[today] >= 5) {
    // If the limit is reached, return a warning message
    return {
      reply:
        "Oops, looks like you've hit the 5-question cap! At this rate, my OpenAI key's gonna drain faster than Fabri's crypto funds. NGMI, try again tomorrow!",
      messages,
    };
  }*/

  try {
    if (content.toLowerCase() === "stop") {
      // Reset the conversation state
      messages = [
        {
          role: "system",
          content: systemPrompt,
        },
      ];
    } else {
      // Add the user's message to the conversation history
      messages.push({
        role: "user",
        content: content,
      });
    }
    const response = await openai.chat.completions.create({
      model: "gpt-4o",
      messages: messages as any,
    });
    const reply = response.choices[0].message.content;
    // Add the assistant's reply to the conversation history
    messages.push({
      role: "assistant",
      content: reply || "No response from OpenAI.",
    });

    userDailyCount[today] = (userDailyCount[today] || 0) + 1;
    dailyQuestionCountPerUser.set(senderAddress, userDailyCount);

    return { reply, messages };
  } catch (error) {
    console.error("Failed to fetch from OpenAI:", error);
    throw error;
  }
}
```
