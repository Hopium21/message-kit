# Loyalty

Create incentives for users to interact with group chats.

## Commands

Here are the commands to manage loyalty:

```bash [cmd]
# Add a member
/points me

# Check the leaderboard
/points leaderboard
```

::::note
:::details[Command declaration]

```json
{
  "name": "Loyalty",
  "icon": "ðŸ”“",
  "description": "Manage group members and metadata.",
  "commands": [
    {
      "command": "/points",
      "description": "Check your points.",
      "params": {
        "type": {
          "default": "",
          "type": "string",
          "values": ["me", "leaderboard"]
        }
      }
    },
    {
      "command": "/points leaderboard",
      "description": "Check the points of a user.",
      "params": {}
    }
  ]
}
```

:::
::::

## Main code

### Incentives

In this example we used the following incentives:

- 10 points for adding a member
- 1 point for each reaction on a message

```jsx [src/handler/loyalty.ts]
import { HandlerContext } from "@xmtp/message-kit";
import { getStackClient } from "../lib/stack.js";

export async function handler(context: HandlerContext) {
  const stack = getStackClient();
  const {
    members,
    getMessageById,
    message: { content, sender, typeId },
  } = context;

  if (typeId === "text") {
    const {
      command,
      params: { type },
    } = content;
    if (command === "points") {
      if (type === "me") {
        const points = await stack?.getPoints(sender.address);
        await context.reply(`You have ${points} points`);
      } else if (type === "leaderboard") {
        const leaderboard = await stack?.getLeaderboard();
        const formattedLeaderboard = leaderboard?.leaderboard
          .map(
            (entry, index) =>
              `${index + 1}. Address: ${entry.address}, Points: ${entry.points}`,
          )
          .join("\n");
        await context.reply(`Leaderboard:\n${formattedLeaderboard}`);
      }
    } else if (sender.username === "me") {
      context.reply("");
    }
  } else if (typeId === "group_updated") {
    const { initiatedByInboxId, addedInboxes } = content;
    const adminAddress = members?.find(
      (member) => member.inboxId === initiatedByInboxId,
    )?.address;
    if (addedInboxes && addedInboxes.length > 0) {
      //if add someone to the group
      await stack?.track("referral", {
        points: 10,
        account: adminAddress ?? "",
      });
    }
  } else if (typeId === "reaction") {
    const { content: emoji, action } = content;
    const msg = await getMessageById(content.reference);
    if (action === "added") {
      const adminAddress = members?.find(
        (member) => member.inboxId === msg?.senderInboxId,
      )?.address;
      let points = 1;
      if (emoji === "ðŸ‘Ž") {
        points = -10;
      } else if (emoji === "ðŸŽ©") {
        points = 10;
      }
      await stack?.track("reaction", {
        points,
        account: adminAddress ?? "",
      });
    }
  }
}
```

## Stack.so middleware

Connect to [Stack.so](https://stack.so) for managing your loyalty program.

```bash [cmd]
npm install @stackso/js-core
```

Add your API key to environment variables.

```bash
STACK_API_KEY= #your api key
```

Connect to Stack.so

```jsx [src/lib/stack.ts]
import { StackClient } from "@stackso/js-core";

let stack: StackClient | null = null;

export function getStackClient(): StackClient {
  if (!stack) {
    if (!process?.env?.STACK_API_KEY) {
      throw new Error("STACK_API_KEY is not defined");
    }
    stack = new StackClient({
      apiKey: process.env.STACK_API_KEY as string,
      pointSystemId: 2893,
    });
  }
  return stack;
}
```
