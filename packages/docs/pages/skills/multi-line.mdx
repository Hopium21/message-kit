# Multi-line Response Handling

XMTP's AI agent can respond with multiple messages, each separated by newlines. This allows for a more natural conversation flow and enables the agent to execute commands between regular messages.

## How It Works

The multi-line processing happens in the `processMultilineResponse` function, which takes the AI's response, splits it into individual messages, and handles each one appropriately:

```typescript
async function processMultilineResponse(
  address: string,
  reply: string,
  context: any,
) {
  // Split response into separate messages and filter out empty lines
  let messages = reply
    .split("\n")
    .map((message) => parseMarkdown(message))
    .filter((message) => message.length > 0);

  // Process each message sequentially
  for (const message of messages) {
    if (message.startsWith("/")) {
      // Handle skill commands
      const response = await context.skill(message);
      // ... handle skill response
    } else {
      // Send regular message
      await context.send(message);
    }
  }
}
```

### Message Types

The agent can send two types of messages in its response:

1. **Regular Messages**: Plain text messages that are sent directly to the user
2. **Skill Commands**: Messages that start with "/" which trigger specific actions

### Example Response

Here's how a multi-line response from the agent might look:

```plaintext
Hello! I'll help you check your balance.
/balance
Your transaction history looks good!
/chart 7d
Here's your weekly chart analysis.
```

### Processing Flow

1. The response is split by newlines
2. Each line is cleaned of markdown formatting
3. Empty lines are filtered out
4. Messages are processed sequentially:
   - Regular messages are sent directly
   - Command messages (starting with "/") trigger skills
   - Skill responses are captured and sent back to the chat

### Important Notes

- Commands must be on their own line
- Each command is processed in order
- The agent can mix regular messages and commands
- Markdown formatting is automatically stripped from responses

## Usage in Prompts

When instructing the AI agent, you can specify multi-line responses using this format:

```plaintext
First message
/command
Follow-up message
```

The agent will understand to separate these into distinct messages, allowing for more dynamic and interactive conversations.
